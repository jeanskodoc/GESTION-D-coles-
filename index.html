<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>École Supérieure  - Plateforme de Gestion Scolaire</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        :root {
            --primary-color: #3498db;
            --secondary-color: #2c3e50;
            --success-color: #2ecc71;
            --warning-color: #f39c12;
            --danger-color: #e74c3c;
            --light-color: #ecf0f1;
            --dark-color: #2c3e50;
            --gray-color: #7f8c8d;
        }

        body {
            background-color: #f5f7fa;
            color: #333;
            line-height: 1.6;
            min-height: 100vh;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
            min-height: 100vh;
        }

        /* Login Screen */
        .login-screen {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
            background: linear-gradient(135deg, var(--secondary-color), var(--primary-color));
        }

        .login-card {
            background: white;
            border-radius: 20px;
            padding: 40px;
            width: 100%;
            max-width: 500px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
        }

        .login-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .login-header .logo {
            font-size: 4rem;
            color: var(--primary-color);
            margin-bottom: 20px;
        }

        .login-header h2 {
            color: var(--secondary-color);
            margin-bottom: 10px;
            font-size: 1.8rem;
        }

        .login-header p {
            color: var(--gray-color);
            font-size: 1rem;
        }

        .login-tabs {
            display: flex;
            margin-bottom: 30px;
            border-bottom: 2px solid #f0f0f0;
        }

        .login-tab {
            flex: 1;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            font-weight: 600;
            color: var(--gray-color);
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
            font-size: 1rem;
        }

        .login-tab.active {
            color: var(--primary-color);
            border-bottom-color: var(--primary-color);
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--secondary-color);
            font-size: 0.95rem;
        }

        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 14px 18px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 1rem;
            transition: all 0.3s;
        }

        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }

        .btn {
            padding: 14px 28px;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 10px;
            width: 100%;
            justify-content: center;
        }

        .btn-primary {
            background-color: var(--primary-color);
            color: white;
        }

        .btn-primary:hover {
            background-color: #2980b9;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.3);
        }

        .btn-success {
            background-color: var(--success-color);
            color: white;
        }

        .btn-success:hover {
            background-color: #27ae60;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(46, 204, 113, 0.3);
        }

        .btn-warning {
            background-color: var(--warning-color);
            color: white;
        }

        .btn-warning:hover {
            background-color: #d68910;
            transform: translateY(-2px);
        }

        .btn-danger {
            background-color: var(--danger-color);
            color: white;
        }

        .btn-danger:hover {
            background-color: #c0392b;
            transform: translateY(-2px);
        }

        .btn-sm {
            padding: 10px 20px;
            font-size: 0.9rem;
            width: auto;
        }

        .alert {
            padding: 16px 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: none;
            font-size: 0.95rem;
        }

        .alert-success {
            background-color: #d5edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .alert-info {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, var(--secondary-color), var(--primary-color));
            color: white;
            padding: 25px 0;
            border-radius: 15px;
            margin-bottom: 30px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            position: relative;
            overflow: hidden;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 30px;
            position: relative;
            z-index: 1;
        }

        .logo-container {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .logo {
            font-size: 3rem;
            color: white;
        }

        .institution-info h1 {
            font-size: 2.2rem;
            margin-bottom: 5px;
        }

        .institution-info .subtitle {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
            background: rgba(255, 255, 255, 0.1);
            padding: 12px 20px;
            border-radius: 50px;
            backdrop-filter: blur(10px);
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            background: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--primary-color);
            font-weight: bold;
            font-size: 1.2rem;
        }

        .security-badge {
            position: absolute;
            top: 20px;
            right: 20px;
            background: var(--success-color);
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        /* Navigation Tabs */
        .nav-tabs {
            display: flex;
            background: white;
            border-radius: 10px;
            margin-bottom: 30px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.08);
            overflow: hidden;
        }

        .nav-tab {
            flex: 1;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--gray-color);
            transition: all 0.3s ease;
            border-bottom: 3px solid transparent;
        }

        .nav-tab.active {
            color: var(--primary-color);
            border-bottom-color: var(--primary-color);
            background-color: rgba(52, 152, 219, 0.05);
        }

        /* Content Panels */
        .content-panel {
            display: none;
        }

        .content-panel.active {
            display: block;
            animation: fadeIn 0.5s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Dashboard Grid */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 25px;
            margin-bottom: 30px;
        }

        .dashboard-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .dashboard-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }

        .dashboard-card h3 {
            color: var(--secondary-color);
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.3rem;
        }

        .card-value {
            font-size: 2.5rem;
            font-weight: bold;
            color: var(--secondary-color);
            margin: 15px 0;
        }

        .card-subtext {
            color: var(--gray-color);
            font-size: 0.9rem;
        }

        /* Quick Actions */
        .quick-actions {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .quick-action-btn {
            background: white;
            border: 2px solid var(--light-color);
            border-radius: 12px;
            padding: 20px;
            display: flex;
            align-items: center;
            gap: 15px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: left;
        }

        .quick-action-btn:hover {
            border-color: var(--primary-color);
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.1);
        }

        .quick-action-icon {
            width: 50px;
            height: 50px;
            background: var(--primary-color);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.5rem;
            flex-shrink: 0;
        }

        .quick-action-btn h4 {
            color: var(--secondary-color);
            margin-bottom: 5px;
            font-size: 1.1rem;
        }

        .quick-action-btn p {
            color: var(--gray-color);
            font-size: 0.9rem;
        }

        /* Form Sections */
        .form-section {
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 25px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--light-color);
            flex-wrap: wrap;
            gap: 15px;
        }

        .section-title {
            color: var(--secondary-color);
            font-size: 1.5rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .btn-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        /* Tables */
        .table-container {
            overflow-x: auto;
            margin-top: 20px;
            border-radius: 10px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.05);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            min-width: 800px;
        }

        th, td {
            padding: 16px 20px;
            text-align: left;
            border-bottom: 1px solid #f0f0f0;
            font-size: 0.95rem;
        }

        th {
            background-color: #f8f9fa;
            font-weight: 700;
            color: var(--secondary-color);
            position: sticky;
            top: 0;
            white-space: nowrap;
        }

        tr:hover {
            background-color: #f9f9f9;
        }

        .actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .action-btn {
            padding: 6px 12px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85rem;
            display: inline-flex;
            align-items: center;
            gap: 5px;
            white-space: nowrap;
            transition: all 0.3s;
        }

        /* Student Portal */
        .student-portal {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }

        .student-info-card {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
        }

        .student-grades {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
            margin-bottom: 30px;
        }

        .grade-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
            border-bottom: 1px solid #f0f0f0;
            flex-wrap: wrap;
            gap: 10px;
        }

        .grade-item:last-child {
            border-bottom: none;
        }

        .grade-info h4 {
            color: var(--secondary-color);
            margin-bottom: 5px;
            font-size: 1.1rem;
        }

        .grade-value {
            font-size: 1.2rem;
            font-weight: bold;
            padding: 8px 15px;
            border-radius: 8px;
            white-space: nowrap;
        }

        .grade-excellent {
            background-color: #d5f4e6;
            color: #27ae60;
        }

        .grade-good {
            background-color: #fff3cd;
            color: #f39c12;
        }

        .grade-average {
            background-color: #d1ecf1;
            color: #17a2b8;
        }

        .grade-poor {
            background-color: #f8d7da;
            color: #e74c3c;
        }

        /* Credentials Display */
        .credentials-box {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 10px;
            padding: 25px;
            margin: 20px 0;
        }

        .credentials-box h4 {
            margin-bottom: 15px;
            font-size: 1.2rem;
            text-align: center;
        }

        .credential-item {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-family: 'Courier New', monospace;
            font-size: 1.1rem;
            flex-wrap: wrap;
            gap: 10px;
        }

        .copy-btn {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            transition: background 0.3s;
            font-size: 0.9rem;
            white-space: nowrap;
        }

        .copy-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 20px;
            overflow-y: auto;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 15px;
            padding: 30px;
            max-width: 600px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
            margin: auto;
        }

        .modal-close {
            position: absolute;
            top: 20px;
            right: 20px;
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--gray-color);
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Loading */
        .loading-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }

        .loading-overlay.active {
            display: flex;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Preview Modal */
        .preview-modal .modal-content {
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .bulletin-preview {
            background: white;
            padding: 30px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            margin-top: 20px;
        }

        .bulletin-header {
            text-align: center;
            margin-bottom: 30px;
            border-bottom: 2px solid var(--primary-color);
            padding-bottom: 20px;
        }

        .bulletin-header h2 {
            color: var(--secondary-color);
            margin-bottom: 10px;
        }

        .bulletin-info {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }

        .bulletin-info-item {
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .bulletin-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }

        .bulletin-table th,
        .bulletin-table td {
            padding: 12px;
            border: 1px solid #ddd;
            text-align: center;
        }

        .bulletin-table th {
            background-color: #f1f1f1;
            font-weight: bold;
        }

        /* File Import Section */
        .file-import-section {
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 25px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
        }

        .file-import-box {
            border: 2px dashed var(--primary-color);
            border-radius: 10px;
            padding: 40px 20px;
            text-align: center;
            background-color: rgba(52, 152, 219, 0.05);
            transition: all 0.3s;
            margin-bottom: 20px;
        }

        .file-import-box:hover {
            background-color: rgba(52, 152, 219, 0.1);
        }

        .file-import-box i {
            font-size: 3rem;
            color: var(--primary-color);
            margin-bottom: 15px;
        }

        .file-import-box h4 {
            color: var(--secondary-color);
            margin-bottom: 10px;
            font-size: 1.3rem;
        }

        .file-import-box p {
            color: var(--gray-color);
            margin-bottom: 20px;
        }

        .file-input-wrapper {
            position: relative;
            display: inline-block;
            width: 100%;
            max-width: 300px;
        }

        .file-input-wrapper input[type="file"] {
            position: absolute;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            opacity: 0;
            cursor: pointer;
        }

        .file-input-label {
            display: inline-block;
            padding: 12px 24px;
            background-color: var(--primary-color);
            color: white;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
        }

        .file-input-label:hover {
            background-color: #2980b9;
            transform: translateY(-2px);
        }

        .file-info {
            margin-top: 15px;
            font-size: 0.9rem;
            color: var(--gray-color);
            text-align: center;
        }

        .imported-data-preview {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
            display: none;
        }

        .imported-data-preview h5 {
            color: var(--secondary-color);
            margin-bottom: 15px;
            font-size: 1.1rem;
        }

        .data-preview-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #e0e0e0;
        }

        .data-preview-item:last-child {
            border-bottom: none;
        }

        /* Footer */
        .footer {
            text-align: center;
            margin-top: 50px;
            padding-top: 20px;
            border-top: 1px solid #e0e0e0;
            color: var(--gray-color);
            font-size: 0.9rem;
        }

        /* Form Row */
        .form-row {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 20px;
        }

        /* Responsive */
        @media (max-width: 992px) {
            .header-content {
                flex-direction: column;
                text-align: center;
                gap: 20px;
            }
            
            .user-info {
                width: 100%;
                justify-content: center;
            }
            
            .nav-tabs {
                flex-direction: column;
            }
            
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
            
            .quick-actions {
                grid-template-columns: 1fr;
            }
            
            .bulletin-info {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .login-card {
                padding: 30px 20px;
            }
            
            .header-content {
                padding: 0 15px;
            }
            
            .institution-info h1 {
                font-size: 1.8rem;
            }
            
            .section-header {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .btn-group {
                width: 100%;
                justify-content: center;
            }
            
            .modal-content {
                padding: 20px;
            }
            
            th, td {
                padding: 12px 15px;
            }
        }

        @media (max-width: 480px) {
            .login-tabs {
                flex-direction: column;
            }
            
            .login-tab {
                padding: 12px;
            }
            
            .user-info {
                flex-direction: column;
                text-align: center;
                padding: 15px;
            }
            
            .actions {
                flex-direction: column;
            }
            
            .action-btn {
                width: 100%;
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div id="loginScreen" class="login-screen">
        <div class="login-card">
            <div class="login-header">
                <div class="logo">
                    <i class="fas fa-graduation-cap"></i>
                </div>
                <h2>École Supérieure </h2>
                <p>Plateforme de Gestion Scolaire & Universitaire</p>
            </div>

            <div class="login-tabs">
                <div class="login-tab active" data-tab="admin">Administration</div>
                <div class="login-tab" data-tab="student">Étudiant</div>
            </div>

            <div id="loginAlert" class="alert"></div>

            <!-- Admin Login Form -->
            <form id="adminLoginForm" class="login-form" style="display: block;">
                <div class="form-group">
                    <label for="adminUsername"><i class="fas fa-user-shield"></i> Identifiant Administrateur</label>
                    <input type="text" id="adminUsername" placeholder="Votre identifiant" required>
                </div>
                <div class="form-group">
                    <label for="adminPassword"><i class="fas fa-key"></i> Mot de passe</label>
                    <input type="password" id="adminPassword" placeholder="Votre mot de passe" required>
                </div>
                <div class="form-group">
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-sign-in-alt"></i> Se Connecter
                    </button>
                </div>
                <div style="text-align: center; margin-top: 15px; color: var(--gray-color); font-size: 0.9rem;">
                    <small>Identifiants par défaut: admin / admin123</small>
                </div>
            </form>

            <!-- Student Login Form -->
            <form id="studentLoginForm" class="login-form" style="display: none;">
                <div class="form-group">
                    <label for="studentMatricule"><i class="fas fa-id-card"></i> Matricule Étudiant</label>
                    <input type="text" id="studentMatricule" placeholder="Votre numéro matricule" required>
                </div>
                <div class="form-group">
                    <label for="studentPassword"><i class="fas fa-lock"></i> Mot de passe</label>
                    <input type="password" id="studentPassword" placeholder="Votre mot de passe" required>
                </div>
                <div class="form-group">
                    <button type="submit" class="btn btn-success">
                        <i class="fas fa-sign-in-alt"></i> Se Connecter
                    </button>
                </div>
                <div style="text-align: center; margin-top: 20px; color: var(--gray-color); font-size: 0.9rem;">
                    <small>Utilisez les identifiants fournis par l'administration</small>
                </div>
            </form>
        </div>
    </div>

    <!-- Main Application -->
    <div id="mainApp" class="container" style="display: none;">
        <!-- Header -->
        <header class="header">
            <div class="security-badge">
                <i class="fas fa-shield-alt"></i> Sécurisé
            </div>
            <div class="header-content">
                <div class="logo-container">
                    <div class="logo">
                        <i class="fas fa-graduation-cap"></i>
                    </div>
                    <div class="institution-info">
                        <h1 id="appTitle">École Supérieure >Écol
                        <p class="subtitle" id="appSubtitle">Plateforme de Gestion Scolaire & Universitaire</p>
                    </div>
                </div>
                <div class="user-info">
                    <div class="user-avatar">
                        <i id="userIcon"></i>
                    </div>
                    <div>
                        <div id="userName">Utilisateur</div>
                        <div id="userRole" style="font-size: 0.9rem; opacity: 0.8;">Rôle</div>
                    </div>
                    <button class="btn btn-danger btn-sm" onclick="logout()" style="padding: 8px 15px; margin-left: 10px;">
                        <i class="fas fa-sign-out-alt"></i>
                    </button>
                </div>
            </div>
        </header>

        <!-- Navigation Tabs -->
        <div id="adminNavTabs" class="nav-tabs" style="display: none;">
            <div class="nav-tab active" data-tab="admin">
                <i class="fas fa-cogs"></i> Administration
            </div>
            <div class="nav-tab" data-tab="student">
                <i class="fas fa-user-graduate"></i> Espace Étudiant
            </div>
        </div>

        <!-- Alert Container -->
        <div id="appAlert" class="alert"></div>

        <!-- Administration Panel -->
        <div id="adminPanel" class="content-panel">
            <!-- Dashboard -->
            <div class="dashboard-grid">
                <div class="dashboard-card">
                    <h3><i class="fas fa-users"></i> Étudiants</h3>
                    <div class="card-value" id="studentCount">0</div>
                    <p class="card-subtext">Total des étudiants inscrits</p>
                </div>
                <div class="dashboard-card">
                    <h3><i class="fas fa-book"></i> Matières</h3>
                    <div class="card-value" id="subjectCount">0</div>
                    <p class="card-subtext">Matières enseignées</p>
                </div>
                <div class="dashboard-card">
                    <h3><i class="fas fa-chart-line"></i> Performance</h3>
                    <div class="card-value" id="avgGrade">0.0</div>
                    <p class="card-subtext">Moyenne générale</p>
                </div>
                <div class="dashboard-card">
                    <h3><i class="fas fa-clipboard-check"></i> Évaluations</h3>
                    <div class="card-value" id="examCount">0</div>
                    <p class="card-subtext">Évaluations enregistrées</p>
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="quick-actions">
                <div class="quick-action-btn" onclick="showAddStudentModal()">
                    <div class="quick-action-icon">
                        <i class="fas fa-user-plus"></i>
                    </div>
                    <div>
                        <h4>Ajouter un Étudiant</h4>
                        <p>Nouvelle inscription avec génération d'identifiants</p>
                    </div>
                </div>
                <div class="quick-action-btn" onclick="showAddSubjectModal()">
                    <div class="quick-action-icon">
                        <i class="fas fa-book-medical"></i>
                    </div>
                    <div>
                        <h4>Ajouter une Matière</h4>
                        <p>Nouveau cours avec coefficients</p>
                    </div>
                </div>
                <div class="quick-action-btn" onclick="showAddGradeModal()">
                    <div class="quick-action-icon">
                        <i class="fas fa-edit"></i>
                    </div>
                    <div>
                        <h4>Saisir des Notes</h4>
                        <p>Évaluation continue des étudiants</p>
                    </div>
                </div>
                <div class="quick-action-btn" onclick="exportAllData()">
                    <div class="quick-action-icon">
                        <i class="fas fa-file-export"></i>
                    </div>
                    <div>
                        <h4>Exporter Données</h4>
                        <p>Exporter toutes les données du système</p>
                    </div>
                </div>
            </div>

            <!-- Students Management -->
            <div class="form-section">
                <div class="section-header">
                    <h2 class="section-title"><i class="fas fa-users-cog"></i> Gestion des Étudiants</h2>
                    <div class="btn-group">
                        <button class="btn btn-primary btn-sm" onclick="showAddStudentModal()">
                            <i class="fas fa-plus"></i> Ajouter
                        </button>
                        <button class="btn btn-warning btn-sm" onclick="showGenerateCredentialsModal()">
                            <i class="fas fa-key"></i> Identifiants
                        </button>
                        <button class="btn btn-success btn-sm" onclick="exportAllData()">
                            <i class="fas fa-file-export"></i> Exporter Tous
                        </button>
                    </div>
                </div>
                <div class="table-container">
                    <table id="studentsTable">
                        <thead>
                            <tr>
                                <th>Matricule</th>
                                <th>Nom & Prénom</th>
                                <th>Classe/Niveau</th>
                                <th>Spécialité</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="studentsList">
                            <!-- Students will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Subjects Management -->
            <div class="form-section">
                <div class="section-header">
                    <h2 class="section-title"><i class="fas fa-book-open"></i> Gestion des Matières</h2>
                    <div class="btn-group">
                        <button class="btn btn-primary btn-sm" onclick="showAddSubjectModal()">
                            <i class="fas fa-plus"></i> Ajouter
                        </button>
                        <button class="btn btn-warning btn-sm" onclick="showAllSubjects()">
                            <i class="fas fa-list"></i> Voir Tout
                        </button>
                    </div>
                </div>
                <div class="table-container">
                    <table id="subjectsTable">
                        <thead>
                            <tr>
                                <th>Code</th>
                                <th>Matière</th>
                                <th>Professeur</th>
                                <th>Coefficient</th>
                                <th>Crédits</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="subjectsList">
                            <!-- Subjects will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Grades Management -->
            <div class="form-section">
                <div class="section-header">
                    <h2 class="section-title"><i class="fas fa-chart-bar"></i> Gestion des Notes</h2>
                    <div class="btn-group">
                        <button class="btn btn-primary btn-sm" onclick="showAddGradeModal()">
                            <i class="fas fa-plus"></i> Ajouter
                        </button>
                        <button class="btn btn-warning btn-sm" onclick="showAllGrades()">
                            <i class="fas fa-list"></i> Voir Tout
                        </button>
                    </div>
                </div>
                <div class="table-container">
                    <table id="gradesTable">
                        <thead>
                            <tr>
                                <th>Étudiant</th>
                                <th>Matière</th>
                                <th>Type</th>
                                <th>Note</th>
                                <th>Date</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="gradesList">
                            <!-- Grades will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Report Generation -->
            <div class="form-section">
                <div class="section-header">
                    <h2 class="section-title"><i class="fas fa-file-contract"></i> Génération des Bulletins</h2>
                </div>
                <div class="form-row">
                    <div class="form-group" style="flex: 1; min-width: 250px;">
                        <label for="reportClass">Classe/Niveau</label>
                        <select id="reportClass" class="form-control">
                            <option value="">Sélectionner une classe</option>
                        </select>
                    </div>
                    <div class="form-group" style="flex: 1; min-width: 250px;">
                        <label for="reportSemester">Semestre/Période</label>
                        <select id="reportSemester" class="form-control">
                            <option value="S1">Semestre 1</option>
                            <option value="S2">Semestre 2</option>
                            <option value="Annual">Annuel</option>
                        </select>
                    </div>
                </div>
                <div class="btn-group">
                    <button class="btn btn-success" onclick="generateReport()">
                        <i class="fas fa-file-pdf"></i> Générer Bulletins
                    </button>
                    <button class="btn btn-warning" onclick="previewReport()">
                        <i class="fas fa-eye"></i> Prévisualiser
                    </button>
                    <button class="btn btn-primary" onclick="exportIndividualFiles()">
                        <i class="fas fa-user-check"></i> Fichiers Individuels
                    </button>
                </div>
            </div>
        </div>

        <!-- Student Portal Panel -->
        <div id="studentPanel" class="content-panel">
            <div class="student-portal">
                <!-- Student Dashboard -->
                <div class="student-dashboard" id="studentDashboard" style="display: none;">
                    <div class="student-info-card">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 15px;">
                            <div>
                                <h2 id="studentFullName">Nom Étudiant</h2>
                                <p id="studentInfo" style="opacity: 0.9;">Classe - Spécialité | Matricule: </p>
                            </div>
                            <div class="btn-group">
                                <button class="btn btn-warning btn-sm" onclick="exportStudentData()">
                                    <i class="fas fa-download"></i> Exporter
                                </button>
                                <button class="btn btn-danger btn-sm" onclick="logoutStudent()">
                                    <i class="fas fa-sign-out-alt"></i> Déconnexion
                                </button>
                            </div>
                        </div>
                        <div class="stats-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-top: 20px;">
                            <div class="stat-card" style="background: rgba(255,255,255,0.1); color: white; text-align: center;">
                                <div style="font-size: 0.9rem; opacity: 0.9;">Moyenne Générale</div>
                                <div class="stat-value" id="studentAverage" style="color: white; font-size: 1.8rem;">0.0</div>
                                <div>/20</div>
                            </div>
                            <div class="stat-card" style="background: rgba(255,255,255,0.1); color: white; text-align: center;">
                                <div style="font-size: 0.9rem; opacity: 0.9;">Matières Validées</div>
                                <div class="stat-value" id="passedSubjects" style="color: white; font-size: 1.8rem;">0</div>
                                <div>/0</div>
                            </div>
                            <div class="stat-card" style="background: rgba(255,255,255,0.1); color: white; text-align: center;">
                                <div style="font-size: 0.9rem; opacity: 0.9;">Notes Enregistrées</div>
                                <div class="stat-value" id="gradesCount" style="color: white; font-size: 1.8rem;">0</div>
                                <div>évaluations</div>
                            </div>
                        </div>
                    </div>

                    <div class="student-grades">
                        <h3 style="margin-bottom: 25px; color: var(--secondary-color);">
                            <i class="fas fa-chart-line"></i> Mes Notes
                        </h3>
                        <div id="studentGradesList">
                            <!-- Student's grades will be loaded here -->
                        </div>
                    </div>

                    <!-- File Import Section for Students -->
                    <div class="file-import-section">
                        <div class="section-header">
                            <h3 class="section-title"><i class="fas fa-file-import"></i> Importer Mes Données</h3>
                        </div>
                        <div class="file-import-box">
                            <i class="fas fa-cloud-upload-alt"></i>
                            <h4>Importer un fichier JSON</h4>
                            <p>Importez votre fichier JSON généré par l'administration pour afficher vos données</p>
                            <div class="file-input-wrapper">
                                <input type="file" id="jsonFileInput" accept=".json" onchange="handleFileImport(this)">
                                <label for="jsonFileInput" class="file-input-label">
                                    <i class="fas fa-folder-open"></i> Choisir un fichier
                                </label>
                            </div>
                            <div class="file-info">
                                <small>Format accepté: .json (fichier généré par EduManage Pro)</small>
                            </div>
                        </div>
                        <div id="importedDataPreview" class="imported-data-preview">
                            <h5>Données importées</h5>
                            <div class="data-preview-item">
                                <span>Étudiant:</span>
                                <span id="importedStudentName">-</span>
                            </div>
                            <div class="data-preview-item">
                                <span>Matricule:</span>
                                <span id="importedStudentMatricule">-</span>
                            </div>
                            <div class="data-preview-item">
                                <span>Nombre de notes:</span>
                                <span id="importedGradesCount">-</span>
                            </div>
                            <div class="data-preview-item">
                                <span>Moyenne générale:</span>
                                <span id="importedAverage">-</span>
                            </div>
                            <div class="btn-group" style="margin-top: 15px;">
                                <button class="btn btn-success btn-sm" onclick="loadImportedStudentData()">
                                    <i class="fas fa-check"></i> Charger ces données
                                </button>
                                <button class="btn btn-danger btn-sm" onclick="clearImportedData()">
                                    <i class="fas fa-times"></i> Effacer
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="form-section" style="margin-top: 30px;">
                        <h3 class="section-title"><i class="fas fa-download"></i> Documents Disponibles</h3>
                        <div class="btn-group">
                            <button class="btn btn-primary" onclick="downloadBulletin()">
                                <i class="fas fa-file-pdf"></i> Bulletin
                            </button>
                            <button class="btn btn-warning" onclick="downloadReleve()">
                                <i class="fas fa-file-alt"></i> Relevé
                            </button>
                            <button class="btn btn-success" onclick="viewAllGrades()">
                                <i class="fas fa-list"></i> Toutes les Notes
                            </button>
                        </div>
                    </div>
                </div>

                <!-- No Data Message -->
                <div id="noStudentData" class="form-section" style="text-align: center; display: none;">
                    <i class="fas fa-user-graduate" style="font-size: 4rem; color: var(--gray-color); margin-bottom: 20px;"></i>
                    <h3 style="color: var(--secondary-color); margin-bottom: 15px;">Aucune donnée disponible</h3>
                    <p style="color: var(--gray-color); margin-bottom: 20px;">
                        Connectez-vous avec vos identifiants ou importez un fichier JSON pour accéder à vos notes et bulletins.
                    </p>
                    <div class="btn-group" style="justify-content: center;">
                        <button class="btn btn-primary" onclick="showLoginForm()">
                            <i class="fas fa-sign-in-alt"></i> Se Connecter
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <div class="footer">
            <p>École Supérieure &copy; 2025 - Plateforme de Gestion Scolaire & Universitaire</p>
            <p>Version 2.1 | Système sécurisé avec authentification</p>
        </div>
    </div>

    <!-- Modals -->
    <!-- Add Student Modal -->
    <div class="modal" id="addStudentModal">
        <div class="modal-content">
            <button class="modal-close" onclick="closeModal('addStudentModal')">&times;</button>
            <h2 style="margin-bottom: 25px; color: var(--secondary-color);">
                <i class="fas fa-user-plus"></i> Ajouter un Étudiant
            </h2>
            <form id="addStudentForm">
                <div class="form-group">
                    <label for="newLastName">Nom *</label>
                    <input type="text" id="newLastName" placeholder="Nom de famille" required>
                </div>
                <div class="form-group">
                    <label for="newFirstName">Prénom *</label>
                    <input type="text" id="newFirstName" placeholder="Prénom" required>
                </div>
                <div class="form-group">
                    <label for="newMatricule">Matricule *</label>
                    <input type="text" id="newMatricule" placeholder="Ex: 2023001" required>
                </div>
                <div class="form-group">
                    <label for="newClass">Classe/Niveau *</label>
                    <select id="newClass" required>
                        <option value="">Sélectionner</option>
                        <option value="Licence 1">Licence 1</option>
                        <option value="Licence 2">Licence 2</option>
                        <option value="Licence 3">Licence 3</option>
                        <option value="Master 1">Master 1</option>
                        <option value="Master 2">Master 2</option>
                        <option value="Doctorat">Doctorat</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="newSpecialty">Spécialité/Filière</label>
                    <input type="text" id="newSpecialty" placeholder="Ex: Informatique">
                </div>
                <div class="form-group">
                    <label for="newEmail">Email</label>
                    <input type="email" id="newEmail" placeholder="etudiant@institution.edu">
                </div>
                <div class="btn-group" style="margin-top: 30px;">
                    <button type="submit" class="btn btn-success">
                        <i class="fas fa-check"></i> Enregistrer
                    </button>
                    <button type="button" class="btn btn-danger" onclick="closeModal('addStudentModal')">
                        <i class="fas fa-times"></i> Annuler
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add Subject Modal -->
    <div class="modal" id="addSubjectModal">
        <div class="modal-content">
            <button class="modal-close" onclick="closeModal('addSubjectModal')">&times;</button>
            <h2 style="margin-bottom: 25px; color: var(--secondary-color);">
                <i class="fas fa-book-medical"></i> Ajouter une Matière
            </h2>
            <form id="addSubjectForm">
                <div class="form-group">
                    <label for="subjectCode">Code de la matière *</label>
                    <input type="text" id="subjectCode" placeholder="Ex: INF101" required>
                </div>
                <div class="form-group">
                    <label for="subjectName">Nom de la matière *</label>
                    <input type="text" id="subjectName" placeholder="Ex: Algorithmique" required>
                </div>
                <div class="form-group">
                    <label for="subjectTeacher">Professeur *</label>
                    <input type="text" id="subjectTeacher" placeholder="Nom du professeur" required>
                </div>
                <div class="form-row">
                    <div class="form-group" style="flex: 1;">
                        <label for="subjectCoefficient">Coefficient</label>
                        <input type="number" id="subjectCoefficient" min="1" max="10" value="1">
                    </div>
                    <div class="form-group" style="flex: 1;">
                        <label for="subjectCredits">Crédits ECTS</label>
                        <input type="number" id="subjectCredits" min="1" max="10" value="3">
                    </div>
                </div>
                <div class="form-group">
                    <label for="subjectDescription">Description</label>
                    <textarea id="subjectDescription" rows="3" placeholder="Description de la matière"></textarea>
                </div>
                <div class="btn-group" style="margin-top: 30px;">
                    <button type="submit" class="btn btn-success">
                        <i class="fas fa-check"></i> Enregistrer
                    </button>
                    <button type="button" class="btn btn-danger" onclick="closeModal('addSubjectModal')">
                        <i class="fas fa-times"></i> Annuler
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add Grade Modal -->
    <div class="modal" id="addGradeModal">
        <div class="modal-content">
            <button class="modal-close" onclick="closeModal('addGradeModal')">&times;</button>
            <h2 style="margin-bottom: 25px; color: var(--secondary-color);">
                <i class="fas fa-edit"></i> Saisir une Note
            </h2>
            <form id="addGradeForm">
                <div class="form-group">
                    <label for="gradeStudent">Étudiant *</label>
                    <select id="gradeStudent" required>
                        <option value="">Sélectionner un étudiant</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="gradeSubject">Matière *</label>
                    <select id="gradeSubject" required>
                        <option value="">Sélectionner une matière</option>
                    </select>
                </div>
                <div class="form-row">
                    <div class="form-group" style="flex: 1;">
                        <label for="gradeValue">Note *</label>
                        <input type="number" id="gradeValue" min="0" max="20" step="0.5" placeholder="0-20" required>
                    </div>
                    <div class="form-group" style="flex: 1;">
                        <label for="gradeMax">Note maximale</label>
                        <input type="number" id="gradeMax" min="10" max="100" value="20">
                    </div>
                </div>
                <div class="form-group">
                    <label for="gradeType">Type d'évaluation</label>
                    <select id="gradeType">
                        <option value="Examen">Examen</option>
                        <option value="Contrôle Continu">Contrôle Continu</option>
                        <option value="Devoir">Devoir</option>
                        <option value="Projet">Projet</option>
                        <option value="Oral">Oral</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="gradeDate">Date de l'évaluation</label>
                    <input type="date" id="gradeDate" value="<?php echo date('Y-m-d'); ?>">
                </div>
                <div class="form-group">
                    <label for="gradeComment">Commentaire</label>
                    <textarea id="gradeComment" rows="2" placeholder="Commentaire sur la note"></textarea>
                </div>
                <div class="btn-group" style="margin-top: 30px;">
                    <button type="submit" class="btn btn-success">
                        <i class="fas fa-check"></i> Enregistrer
                    </button>
                    <button type="button" class="btn btn-danger" onclick="closeModal('addGradeModal')">
                        <i class="fas fa-times"></i> Annuler
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Generate Credentials Modal -->
    <div class="modal" id="generateCredentialsModal">
        <div class="modal-content">
            <button class="modal-close" onclick="closeModal('generateCredentialsModal')">&times;</button>
            <h2 style="margin-bottom: 25px; color: var(--secondary-color);">
                <i class="fas fa-key"></i> Générer des Identifiants
            </h2>
            <div class="form-group">
                <label for="studentSelect">Sélectionner un étudiant</label>
                <select id="studentSelect" class="form-control">
                    <option value="">Choisir un étudiant</option>
                </select>
            </div>
            
            <div id="credentialsDisplay" style="display: none;">
                <div class="credentials-box">
                    <h4>Identifiants Générés</h4>
                    <div class="credential-item">
                        <span>Matricule:</span>
                        <span id="credMatricule"></span>
                        <button class="copy-btn" onclick="copyToClipboard('credMatricule')">
                            <i class="fas fa-copy"></i>
                        </button>
                    </div>
                    <div class="credential-item">
                        <span>Identifiant:</span>
                        <span id="credUsername"></span>
                        <button class="copy-btn" onclick="copyToClipboard('credUsername')">
                            <i class="fas fa-copy"></i>
                        </button>
                    </div>
                    <div class="credential-item">
                        <span>Mot de passe:</span>
                        <span id="credPassword"></span>
                        <button class="copy-btn" onclick="copyToClipboard('credPassword')">
                            <i class="fas fa-copy"></i>
                        </button>
                    </div>
                </div>
                <p style="text-align: center; color: var(--gray-color); margin-top: 15px; font-size: 0.9rem;">
                    <i class="fas fa-info-circle"></i> Ces identifiants permettront à l'étudiant de se connecter
                </p>
            </div>
            
            <div class="btn-group" style="margin-top: 30px;">
                <button class="btn btn-primary" onclick="generateNewCredentials()">
                    <i class="fas fa-redo"></i> Régénérer
                </button>
                <button class="btn btn-warning" onclick="exportStudentCredentials()">
                    <i class="fas fa-file-export"></i> Exporter JSON
                </button>
                <button class="btn btn-danger" onclick="closeModal('generateCredentialsModal')">
                    <i class="fas fa-times"></i> Fermer
                </button>
            </div>
        </div>
    </div>

    <!-- View All Subjects Modal -->
    <div class="modal" id="viewAllSubjectsModal">
        <div class="modal-content">
            <button class="modal-close" onclick="closeModal('viewAllSubjectsModal')">&times;</button>
            <h2 style="margin-bottom: 25px; color: var(--secondary-color);">
                <i class="fas fa-list"></i> Toutes les Matières
            </h2>
            <div class="table-container">
                <table id="allSubjectsTable">
                    <thead>
                        <tr>
                            <th>Code</th>
                            <th>Matière</th>
                            <th>Professeur</th>
                            <th>Coefficient</th>
                            <th>Crédits</th>
                            <th>Étudiants</th>
                        </tr>
                    </thead>
                    <tbody id="allSubjectsList">
                        <!-- All subjects will be loaded here -->
                    </tbody>
                </table>
            </div>
            <div class="btn-group" style="margin-top: 20px; justify-content: center;">
                <button class="btn btn-danger" onclick="closeModal('viewAllSubjectsModal')">
                    <i class="fas fa-times"></i> Fermer
                </button>
            </div>
        </div>
    </div>

    <!-- View All Grades Modal -->
    <div class="modal" id="viewAllGradesModal">
        <div class="modal-content">
            <button class="modal-close" onclick="closeModal('viewAllGradesModal')">&times;</button>
            <h2 style="margin-bottom: 25px; color: var(--secondary-color);">
                <i class="fas fa-list"></i> Toutes les Notes
            </h2>
            <div class="table-container">
                <table id="allGradesTable">
                    <thead>
                        <tr>
                            <th>Étudiant</th>
                            <th>Matière</th>
                            <th>Type</th>
                            <th>Note</th>
                            <th>Date</th>
                            <th>Commentaire</th>
                        </tr>
                    </thead>
                    <tbody id="allGradesList">
                        <!-- All grades will be loaded here -->
                    </tbody>
                </table>
            </div>
            <div class="btn-group" style="margin-top: 20px; justify-content: center;">
                <button class="btn btn-danger" onclick="closeModal('viewAllGradesModal')">
                    <i class="fas fa-times"></i> Fermer
                </button>
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="spinner"></div>
    </div>

    <script>
        // ====================
        // APPLICATION DATA
        // ====================
        const appData = {
            // Admin credentials
            adminCredentials: {
                username: 'admin',
                password: 'admin123'
            },
            
            // Current session
            currentSession: {
                userType: null,
                userData: null,
                loginTime: null,
                currentStudentId: null
            },
            
            // Academic data
            students: [],
            subjects: [],
            grades: [],
            
            // Imported data for student portal
            importedStudentData: null,
            
            // Constants
            localStorageKeys: {
                adminData: 'eduManageAdminData',
                session: 'eduManageSession',
                importedStudentData: 'eduManageImportedStudentData'
            }
        };

        // ====================
        // INITIALIZATION
        // ====================
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
        });

        function initializeApp() {
            loadSavedData();
            setupEventListeners();
            initLoginTabs();
        }

        // ====================
        // EVENT LISTENERS
        // ====================
        function setupEventListeners() {
            // Login forms
            document.getElementById('adminLoginForm').addEventListener('submit', handleAdminLogin);
            document.getElementById('studentLoginForm').addEventListener('submit', handleStudentLogin);
            
            // CRUD forms
            document.getElementById('addStudentForm').addEventListener('submit', addStudent);
            document.getElementById('addSubjectForm').addEventListener('submit', addSubject);
            document.getElementById('addGradeForm').addEventListener('submit', addGrade);
            
            // Student select
            document.getElementById('studentSelect').addEventListener('change', loadStudentForCredentials);
            
            // Navigation tabs
            document.addEventListener('click', function(e) {
                if (e.target.closest('.nav-tab')) {
                    const tab = e.target.closest('.nav-tab');
                    const tabId = tab.dataset.tab;
                    showPanel(tabId);
                }
            });
        }

        function initLoginTabs() {
            const tabs = document.querySelectorAll('.login-tab');
            tabs.forEach(tab => {
                tab.addEventListener('click', function() {
                    const tabId = this.dataset.tab;
                    
                    tabs.forEach(t => t.classList.remove('active'));
                    this.classList.add('active');
                    
                    document.getElementById('adminLoginForm').style.display = 
                        tabId === 'admin' ? 'block' : 'none';
                    document.getElementById('studentLoginForm').style.display = 
                        tabId === 'student' ? 'block' : 'none';
                });
            });
        }

        // ====================
        // DATA MANAGEMENT
        // ====================
        function loadSavedData() {
            try {
                // Load admin data
                const savedAdminData = localStorage.getItem(appData.localStorageKeys.adminData);
                if (savedAdminData) {
                    const data = JSON.parse(savedAdminData);
                    appData.students = data.students || [];
                    appData.subjects = data.subjects || [];
                    appData.grades = data.grades || [];
                }
                
                // Load session
                const savedSession = localStorage.getItem(appData.localStorageKeys.session);
                if (savedSession) {
                    appData.currentSession = JSON.parse(savedSession);
                    
                    // Check if session is still valid (less than 8 hours old)
                    const loginTime = new Date(appData.currentSession.loginTime);
                    const now = new Date();
                    const hoursDiff = (now - loginTime) / (1000 * 60 * 60);
                    
                    if (hoursDiff < 8) {
                        autoLogin();
                    } else {
                        localStorage.removeItem(appData.localStorageKeys.session);
                    }
                }
                
                // Load imported student data
                const savedImportedData = localStorage.getItem(appData.localStorageKeys.importedStudentData);
                if (savedImportedData) {
                    appData.importedStudentData = JSON.parse(savedImportedData);
                }
            } catch (error) {
                console.error('Error loading saved data:', error);
                showAlert('Erreur lors du chargement des données', 'error');
            }
        }

        function saveAdminData() {
            try {
                const data = {
                    students: appData.students,
                    subjects: appData.subjects,
                    grades: appData.grades,
                    lastModified: new Date().toISOString()
                };
                localStorage.setItem(appData.localStorageKeys.adminData, JSON.stringify(data));
            } catch (error) {
                console.error('Error saving admin data:', error);
            }
        }

        function saveSession() {
            try {
                localStorage.setItem(appData.localStorageKeys.session, JSON.stringify(appData.currentSession));
            } catch (error) {
                console.error('Error saving session:', error);
            }
        }

        function saveImportedStudentData() {
            try {
                localStorage.setItem(
                    appData.localStorageKeys.importedStudentData, 
                    JSON.stringify(appData.importedStudentData)
                );
            } catch (error) {
                console.error('Error saving imported student data:', error);
            }
        }

        // ====================
        // AUTHENTICATION
        // ====================
        function handleAdminLogin(e) {
            e.preventDefault();
            showLoading();
            
            const username = document.getElementById('adminUsername').value.trim();
            const password = document.getElementById('adminPassword').value;
            
            if (!username || !password) {
                hideLoading();
                showLoginAlert('Veuillez remplir tous les champs', 'error');
                return;
            }
            
            if (username === appData.adminCredentials.username && 
                password === appData.adminCredentials.password) {
                
                appData.currentSession = {
                    userType: 'admin',
                    userData: { 
                        name: 'Administrateur', 
                        role: 'Administrateur',
                        username: username 
                    },
                    loginTime: new Date().toISOString(),
                    currentStudentId: null
                };
                
                saveSession();
                showMainApplication('admin');
                hideLoading();
                showAlert('Connexion administrateur réussie !', 'success');
                
            } else {
                hideLoading();
                showLoginAlert('Identifiants incorrects', 'error');
            }
        }

        function handleStudentLogin(e) {
            e.preventDefault();
            showLoading();
            
            const matricule = document.getElementById('studentMatricule').value.trim();
            const password = document.getElementById('studentPassword').value;
            
            if (!matricule || !password) {
                hideLoading();
                showLoginAlert('Veuillez remplir tous les champs', 'error');
                return;
            }
            
            // Find student by matricule
            const student = appData.students.find(s => s.matricule === matricule);
            
            if (!student) {
                hideLoading();
                showLoginAlert('Matricule incorrect ou étudiant non enregistré', 'error');
                return;
            }
            
            if (student.password !== password) {
                hideLoading();
                showLoginAlert('Mot de passe incorrect', 'error');
                return;
            }
            
            appData.currentSession = {
                userType: 'student',
                userData: student,
                loginTime: new Date().toISOString(),
                currentStudentId: student.id
            };
            
            saveSession();
            showMainApplication('student');
            hideLoading();
            showAlert('Connexion étudiante réussie !', 'success');
        }

        function autoLogin() {
            if (appData.currentSession.userType === 'admin') {
                showMainApplication('admin');
            } else if (appData.currentSession.userType === 'student') {
                showMainApplication('student');
            }
        }

        function logout() {
            appData.currentSession = {
                userType: null,
                userData: null,
                loginTime: null,
                currentStudentId: null
            };
            localStorage.removeItem(appData.localStorageKeys.session);
            
            document.getElementById('loginScreen').style.display = 'flex';
            document.getElementById('mainApp').style.display = 'none';
            
            document.getElementById('adminLoginForm').reset();
            document.getElementById('studentLoginForm').reset();
            
            showLoginAlert('Déconnexion réussie', 'success');
        }

        function logoutStudent() {
            logout();
            document.querySelector('.login-tab[data-tab="student"]').click();
        }

        // ====================
        // UI MANAGEMENT
        // ====================
        function showMainApplication(userType) {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('mainApp').style.display = 'block';
            
            if (userType === 'admin') {
                // Setup admin interface
                document.getElementById('userName').textContent = 'Administrateur';
                document.getElementById('userRole').textContent = 'Administrateur';
                document.getElementById('userIcon').className = 'fas fa-user-shield';
                document.getElementById('appTitle').textContent = 'EduManage Pro - Administration';
                document.getElementById('adminNavTabs').style.display = 'flex';
                
                // Initialize admin data
                updateDashboard();
                renderStudentsTable();
                renderSubjectsTable();
                renderGradesTable();
                populateSelects();
                
                // Show admin panel
                showPanel('admin');
                
            } else if (userType === 'student') {
                // Setup student interface
                const student = appData.currentSession.userData;
                document.getElementById('userName').textContent = 
                    `${student.firstName} ${student.lastName}`;
                document.getElementById('userRole').textContent = 'Étudiant';
                document.getElementById('userIcon').className = 'fas fa-user-graduate';
                document.getElementById('appTitle').textContent = 'EduManage Pro - Espace Étudiant';
                document.getElementById('adminNavTabs').style.display = 'none';
                
                // Show student dashboard
                document.getElementById('studentDashboard').style.display = 'block';
                document.getElementById('noStudentData').style.display = 'none';
                displayStudentData();
                
                // Show student panel
                showPanel('student');
            }
        }

        function showPanel(panelId) {
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            const activeTab = document.querySelector(`.nav-tab[data-tab="${panelId}"]`);
            if (activeTab) {
                activeTab.classList.add('active');
            }
            
            document.querySelectorAll('.content-panel').forEach(panel => {
                panel.classList.remove('active');
            });
            document.getElementById(panelId + 'Panel').classList.add('active');
        }

        function showLoginForm() {
            document.getElementById('studentDashboard').style.display = 'none';
            document.getElementById('noStudentData').style.display = 'none';
            document.getElementById('loginScreen').style.display = 'flex';
            document.getElementById('mainApp').style.display = 'none';
            document.querySelector('.login-tab[data-tab="student"]').click();
        }

        // ====================
        // DASHBOARD & TABLES
        // ====================
        function updateDashboard() {
            document.getElementById('studentCount').textContent = appData.students.length;
            document.getElementById('subjectCount').textContent = appData.subjects.length;
            document.getElementById('examCount').textContent = appData.grades.length;
            
            if (appData.grades.length > 0) {
                const total = appData.grades.reduce((sum, grade) => sum + grade.value, 0);
                const average = (total / appData.grades.length).toFixed(1);
                document.getElementById('avgGrade').textContent = average;
            } else {
                document.getElementById('avgGrade').textContent = '0.0';
            }
        }

        function renderStudentsTable() {
            const tbody = document.getElementById('studentsList');
            tbody.innerHTML = '';
            
            if (appData.students.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="5" style="text-align: center; padding: 40px; color: var(--gray-color);">
                            <i class="fas fa-users-slash" style="font-size: 2rem; margin-bottom: 10px; display: block;"></i>
                            Aucun étudiant enregistré
                        </td>
                    </tr>
                `;
                return;
            }
            
            appData.students.forEach(student => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><strong>${student.matricule}</strong></td>
                    <td>${student.lastName} ${student.firstName}</td>
                    <td>${student.class}</td>
                    <td>${student.specialty || '-'}</td>
                    <td class="actions">
                        <button class="action-btn" style="background: #e3f2fd; color: #1976d2;" onclick="viewStudent('${student.id}')">
                            <i class="fas fa-eye"></i> Voir
                        </button>
                        <button class="action-btn" style="background: #d4edda; color: #155724;" onclick="exportStudentFile('${student.matricule}')">
                            <i class="fas fa-file-export"></i> Exporter
                        </button>
                        <button class="action-btn" style="background: #f8d7da; color: #721c24;" onclick="deleteStudent('${student.id}')">
                            <i class="fas fa-trash"></i> Supprimer
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function renderSubjectsTable() {
            const tbody = document.getElementById('subjectsList');
            tbody.innerHTML = '';
            
            if (appData.subjects.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" style="text-align: center; padding: 40px; color: var(--gray-color);">
                            <i class="fas fa-books" style="font-size: 2rem; margin-bottom: 10px; display: block;"></i>
                            Aucune matière enregistrée
                        </td>
                    </tr>
                `;
                return;
            }
            
            appData.subjects.forEach(subject => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><strong>${subject.code || 'N/A'}</strong></td>
                    <td>${subject.name}</td>
                    <td>${subject.teacher}</td>
                    <td>${subject.coefficient || 1}</td>
                    <td>${subject.credits || '-'}</td>
                    <td class="actions">
                        <button class="action-btn" style="background: #fff3cd; color: #856404;" onclick="editSubject('${subject.id}')">
                            <i class="fas fa-edit"></i> Modifier
                        </button>
                        <button class="action-btn" style="background: #f8d7da; color: #721c24;" onclick="deleteSubject('${subject.id}')">
                            <i class="fas fa-trash"></i> Supprimer
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function renderGradesTable() {
            const tbody = document.getElementById('gradesList');
            tbody.innerHTML = '';
            
            if (appData.grades.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" style="text-align: center; padding: 40px; color: var(--gray-color);">
                            <i class="fas fa-chart-bar" style="font-size: 2rem; margin-bottom: 10px; display: block;"></i>
                            Aucune note enregistrée
                        </td>
                    </tr>
                `;
                return;
            }
            
            appData.grades.forEach(grade => {
                const student = appData.students.find(s => s.id === grade.studentId);
                const subject = appData.subjects.find(s => s.id === grade.subjectId);
                
                if (!student || !subject) return;
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${student.firstName} ${student.lastName}</td>
                    <td>${subject.name}</td>
                    <td>${grade.type || 'Note'}</td>
                    <td>${grade.value.toFixed(2)}/${grade.maxScore || 20}</td>
                    <td>${new Date(grade.date).toLocaleDateString('fr-FR')}</td>
                    <td class="actions">
                        <button class="action-btn" style="background: #f8d7da; color: #721c24;" onclick="deleteGrade('${grade.id}')">
                            <i class="fas fa-trash"></i> Supprimer
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function populateSelects() {
            // Student select for credentials
            const studentSelect = document.getElementById('studentSelect');
            studentSelect.innerHTML = '<option value="">Choisir un étudiant</option>';
            
            // Grade student select
            const gradeStudent = document.getElementById('gradeStudent');
            gradeStudent.innerHTML = '<option value="">Sélectionner un étudiant</option>';
            
            // Grade subject select
            const gradeSubject = document.getElementById('gradeSubject');
            gradeSubject.innerHTML = '<option value="">Sélectionner une matière</option>';
            
            // Report class select
            const reportClass = document.getElementById('reportClass');
            const classes = [...new Set(appData.students.map(s => s.class))];
            reportClass.innerHTML = '<option value="">Sélectionner une classe</option>';
            classes.forEach(cls => {
                const option = document.createElement('option');
                option.value = cls;
                option.textContent = cls;
                reportClass.appendChild(option);
            });
            
            appData.students.forEach(student => {
                // For credentials
                const option1 = document.createElement('option');
                option1.value = student.id;
                option1.textContent = `${student.lastName} ${student.firstName} (${student.matricule})`;
                studentSelect.appendChild(option1);
                
                // For grades
                const option2 = document.createElement('option');
                option2.value = student.id;
                option2.textContent = `${student.lastName} ${student.firstName} - ${student.matricule}`;
                gradeStudent.appendChild(option2);
            });
            
            appData.subjects.forEach(subject => {
                const option = document.createElement('option');
                option.value = subject.id;
                option.textContent = `${subject.code} - ${subject.name}`;
                gradeSubject.appendChild(option);
            });
        }

        // ====================
        // STUDENT MANAGEMENT
        // ====================
        function showAddStudentModal() {
            document.getElementById('addStudentForm').reset();
            showModal('addStudentModal');
        }

        function addStudent(e) {
            e.preventDefault();
            showLoading();
            
            const lastName = document.getElementById('newLastName').value.trim();
            const firstName = document.getElementById('newFirstName').value.trim();
            const matricule = document.getElementById('newMatricule').value.trim();
            const studentClass = document.getElementById('newClass').value;
            const specialty = document.getElementById('newSpecialty').value.trim();
            const email = document.getElementById('newEmail').value.trim();
            
            if (!lastName || !firstName || !matricule || !studentClass) {
                hideLoading();
                showAlert('Veuillez remplir tous les champs obligatoires', 'error');
                return;
            }
            
            if (appData.students.some(s => s.matricule === matricule)) {
                hideLoading();
                showAlert('Un étudiant avec ce matricule existe déjà', 'error');
                return;
            }
            
            const username = generateUsername(firstName, lastName);
            const password = generatePassword();
            
            const student = {
                id: Date.now().toString(),
                lastName,
                firstName,
                matricule,
                class: studentClass,
                specialty,
                email,
                username,
                password,
                createdAt: new Date().toISOString()
            };
            
            appData.students.push(student);
            saveAdminData();
            updateDashboard();
            renderStudentsTable();
            populateSelects();
            
            document.getElementById('addStudentForm').reset();
            closeModal('addStudentModal');
            hideLoading();
            
            showStudentCredentials(student);
            showAlert(`Étudiant ${firstName} ${lastName} ajouté avec succès`, 'success');
        }

        function generateUsername(firstName, lastName) {
            const firstInitial = firstName.charAt(0).toLowerCase();
            const cleanLastName = lastName.toLowerCase().replace(/\s/g, '');
            const randomNum = Math.floor(Math.random() * 90) + 10;
            return firstInitial + cleanLastName + randomNum;
        }

        function generatePassword() {
            const length = 10;
            const charset = 'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789!@#$%^&*';
            let password = '';
            for (let i = 0; i < length; i++) {
                const randomIndex = Math.floor(Math.random() * charset.length);
                password += charset[randomIndex];
            }
            return password;
        }

        function showStudentCredentials(student) {
            const modalHTML = `
                <div class="modal active" id="credentialsModal">
                    <div class="modal-content">
                        <button class="modal-close" onclick="closeModal('credentialsModal')">&times;</button>
                        <h2 style="margin-bottom: 25px; color: var(--secondary-color);">
                            <i class="fas fa-key"></i> Identifiants Générés
                        </h2>
                        <div class="credentials-box">
                            <h4>Identifiants pour ${student.firstName} ${student.lastName}</h4>
                            <div class="credential-item">
                                <span>Matricule:</span>
                                <span>${student.matricule}</span>
                                <button class="copy-btn" onclick="copyToClipboard('${student.matricule}')">
                                    <i class="fas fa-copy"></i>
                                </button>
                            </div>
                            <div class="credential-item">
                                <span>Identifiant:</span>
                                <span>${student.username}</span>
                                <button class="copy-btn" onclick="copyToClipboard('${student.username}')">
                                    <i class="fas fa-copy"></i>
                                </button>
                            </div>
                            <div class="credential-item">
                                <span>Mot de passe:</span>
                                <span>${student.password}</span>
                                <button class="copy-btn" onclick="copyToClipboard('${student.password}')">
                                    <i class="fas fa-copy"></i>
                                </button>
                            </div>
                        </div>
                        <p style="text-align: center; color: var(--gray-color); margin-top: 15px; font-size: 0.9rem;">
                            <i class="fas fa-info-circle"></i> Notez ces identifiants pour la connexion étudiante
                        </p>
                        <div class="btn-group" style="margin-top: 20px; justify-content: center;">
                            <button class="btn btn-success" onclick="exportStudentFile('${student.matricule}'); closeModal('credentialsModal');">
                                <i class="fas fa-file-export"></i> Exporter en JSON
                            </button>
                            <button class="btn btn-primary" onclick="closeModal('credentialsModal')">
                                <i class="fas fa-check"></i> Compris
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            const existingModal = document.getElementById('credentialsModal');
            if (existingModal) {
                existingModal.remove();
            }
            
            document.body.insertAdjacentHTML('beforeend', modalHTML);
        }

        function deleteStudent(studentId) {
            if (confirm('Êtes-vous sûr de vouloir supprimer cet étudiant ?')) {
                appData.students = appData.students.filter(s => s.id !== studentId);
                appData.grades = appData.grades.filter(g => g.studentId !== studentId);
                saveAdminData();
                updateDashboard();
                renderStudentsTable();
                renderGradesTable();
                populateSelects();
                showAlert('Étudiant supprimé avec succès', 'success');
            }
        }

        function viewStudent(studentId) {
            const student = appData.students.find(s => s.id === studentId);
            if (student) {
                const grades = appData.grades.filter(g => g.studentId === studentId);
                let message = `Détails de ${student.firstName} ${student.lastName}\n`;
                message += `Matricule: ${student.matricule}\n`;
                message += `Classe: ${student.class}\n`;
                message += `Spécialité: ${student.specialty || 'Non spécifiée'}\n`;
                message += `Email: ${student.email || 'Non spécifié'}\n`;
                message += `Nombre de notes: ${grades.length}`;
                
                showAlert(message, 'info');
            }
        }

        // ====================
        // SUBJECT MANAGEMENT
        // ====================
        function showAddSubjectModal() {
            document.getElementById('addSubjectForm').reset();
            document.getElementById('subjectCoefficient').value = 1;
            document.getElementById('subjectCredits').value = 3;
            showModal('addSubjectModal');
        }

        function addSubject(e) {
            e.preventDefault();
            showLoading();
            
            const code = document.getElementById('subjectCode').value.trim();
            const name = document.getElementById('subjectName').value.trim();
            const teacher = document.getElementById('subjectTeacher').value.trim();
            const coefficient = parseInt(document.getElementById('subjectCoefficient').value) || 1;
            const credits = parseInt(document.getElementById('subjectCredits').value) || 3;
            const description = document.getElementById('subjectDescription').value.trim();
            
            if (!code || !name || !teacher) {
                hideLoading();
                showAlert('Veuillez remplir tous les champs obligatoires', 'error');
                return;
            }
            
            if (appData.subjects.some(s => s.code === code)) {
                hideLoading();
                showAlert('Une matière avec ce code existe déjà', 'error');
                return;
            }
            
            const subject = {
                id: Date.now().toString(),
                code,
                name,
                teacher,
                coefficient,
                credits,
                description,
                createdAt: new Date().toISOString()
            };
            
            appData.subjects.push(subject);
            saveAdminData();
            updateDashboard();
            renderSubjectsTable();
            populateSelects();
            
            document.getElementById('addSubjectForm').reset();
            closeModal('addSubjectModal');
            hideLoading();
            
            showAlert(`Matière "${name}" ajoutée avec succès`, 'success');
        }

        function deleteSubject(subjectId) {
            if (confirm('Êtes-vous sûr de vouloir supprimer cette matière ?')) {
                appData.subjects = appData.subjects.filter(s => s.id !== subjectId);
                appData.grades = appData.grades.filter(g => g.subjectId !== subjectId);
                saveAdminData();
                updateDashboard();
                renderSubjectsTable();
                renderGradesTable();
                populateSelects();
                showAlert('Matière supprimée avec succès', 'success');
            }
        }

        function editSubject(subjectId) {
            const subject = appData.subjects.find(s => s.id === subjectId);
            if (subject) {
                // Pré-remplir le formulaire
                document.getElementById('subjectCode').value = subject.code;
                document.getElementById('subjectName').value = subject.name;
                document.getElementById('subjectTeacher').value = subject.teacher;
                document.getElementById('subjectCoefficient').value = subject.coefficient || 1;
                document.getElementById('subjectCredits').value = subject.credits || 3;
                document.getElementById('subjectDescription').value = subject.description || '';
                
                showAddSubjectModal();
                showAlert(`Modification de la matière "${subject.name}"`, 'info');
            }
        }

        function showAllSubjects() {
            const tbody = document.getElementById('allSubjectsList');
            tbody.innerHTML = '';
            
            if (appData.subjects.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" style="text-align: center; padding: 40px; color: var(--gray-color);">
                            <i class="fas fa-books" style="font-size: 2rem; margin-bottom: 10px; display: block;"></i>
                            Aucune matière enregistrée
                        </td>
                    </tr>
                `;
            } else {
                appData.subjects.forEach(subject => {
                    // Compter le nombre d'étudiants ayant des notes dans cette matière
                    const studentsWithGrades = new Set(
                        appData.grades
                            .filter(g => g.subjectId === subject.id)
                            .map(g => g.studentId)
                    ).size;
                    
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td><strong>${subject.code || 'N/A'}</strong></td>
                        <td>${subject.name}</td>
                        <td>${subject.teacher}</td>
                        <td>${subject.coefficient || 1}</td>
                        <td>${subject.credits || '-'}</td>
                        <td>${studentsWithGrades} étudiant(s)</td>
                    `;
                    tbody.appendChild(row);
                });
            }
            
            showModal('viewAllSubjectsModal');
        }

        // ====================
        // GRADE MANAGEMENT
        // ====================
        function showAddGradeModal() {
            document.getElementById('addGradeForm').reset();
            document.getElementById('gradeDate').value = new Date().toISOString().split('T')[0];
            document.getElementById('gradeMax').value = 20;
            showModal('addGradeModal');
        }

        function addGrade(e) {
            e.preventDefault();
            showLoading();
            
            const studentId = document.getElementById('gradeStudent').value;
            const subjectId = document.getElementById('gradeSubject').value;
            const value = parseFloat(document.getElementById('gradeValue').value);
            const maxScore = parseInt(document.getElementById('gradeMax').value) || 20;
            const type = document.getElementById('gradeType').value;
            const date = document.getElementById('gradeDate').value;
            const comment = document.getElementById('gradeComment').value.trim();
            
            if (!studentId || !subjectId || isNaN(value)) {
                hideLoading();
                showAlert('Veuillez remplir tous les champs obligatoires', 'error');
                return;
            }
            
            if (value < 0 || value > maxScore) {
                hideLoading();
                showAlert(`La note doit être comprise entre 0 et ${maxScore}`, 'error');
                return;
            }
            
            const grade = {
                id: Date.now().toString(),
                studentId,
                subjectId,
                value,
                maxScore,
                type,
                date,
                comment,
                createdAt: new Date().toISOString()
            };
            
            appData.grades.push(grade);
            saveAdminData();
            updateDashboard();
            renderGradesTable();
            
            document.getElementById('addGradeForm').reset();
            closeModal('addGradeModal');
            hideLoading();
            
            showAlert(`Note ajoutée avec succès`, 'success');
        }

        function deleteGrade(gradeId) {
            if (confirm('Êtes-vous sûr de vouloir supprimer cette note ?')) {
                appData.grades = appData.grades.filter(g => g.id !== gradeId);
                saveAdminData();
                updateDashboard();
                renderGradesTable();
                showAlert('Note supprimée avec succès', 'success');
            }
        }

        function showAllGrades() {
            const tbody = document.getElementById('allGradesList');
            tbody.innerHTML = '';
            
            if (appData.grades.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" style="text-align: center; padding: 40px; color: var(--gray-color);">
                            <i class="fas fa-chart-bar" style="font-size: 2rem; margin-bottom: 10px; display: block;"></i>
                            Aucune note enregistrée
                        </td>
                    </tr>
                `;
            } else {
                appData.grades.forEach(grade => {
                    const student = appData.students.find(s => s.id === grade.studentId);
                    const subject = appData.subjects.find(s => s.id === grade.subjectId);
                    
                    if (!student || !subject) return;
                    
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${student.firstName} ${student.lastName}</td>
                        <td>${subject.name}</td>
                        <td>${grade.type || 'Note'}</td>
                        <td>${grade.value.toFixed(2)}/${grade.maxScore || 20}</td>
                        <td>${new Date(grade.date).toLocaleDateString('fr-FR')}</td>
                        <td>${grade.comment || '-'}</td>
                    `;
                    tbody.appendChild(row);
                });
            }
            
            showModal('viewAllGradesModal');
        }

        // ====================
        // CREDENTIALS MANAGEMENT
        // ====================
        function showGenerateCredentialsModal() {
            populateSelects();
            showModal('generateCredentialsModal');
        }

        function loadStudentForCredentials() {
            const studentId = document.getElementById('studentSelect').value;
            const student = appData.students.find(s => s.id === studentId);
            
            if (student) {
                document.getElementById('credMatricule').textContent = student.matricule;
                document.getElementById('credUsername').textContent = student.username;
                document.getElementById('credPassword').textContent = student.password;
                document.getElementById('credentialsDisplay').style.display = 'block';
            } else {
                document.getElementById('credentialsDisplay').style.display = 'none';
            }
        }

        function generateNewCredentials() {
            const studentId = document.getElementById('studentSelect').value;
            const student = appData.students.find(s => s.id === studentId);
            
            if (student) {
                student.username = generateUsername(student.firstName, student.lastName);
                student.password = generatePassword();
                
                saveAdminData();
                loadStudentForCredentials();
                showAlert('Identifiants régénérés avec succès', 'success');
            }
        }

        // ====================
        // FILE IMPORT FOR STUDENTS
        // ====================
        function handleFileImport(input) {
            const file = input.files[0];
            if (!file) return;
            
            if (!file.name.endsWith('.json')) {
                showAlert('Veuillez sélectionner un fichier JSON', 'error');
                return;
            }
            
            showLoading();
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    
                    // Validate the imported data structure
                    if (!data.student || !data.grades || !data.statistics) {
                        throw new Error('Format de fichier invalide. Le fichier doit contenir les données d\'un étudiant.');
                    }
                    
                    // Store the imported data
                    appData.importedStudentData = data;
                    saveImportedStudentData();
                    
                    // Display preview
                    displayImportedDataPreview(data);
                    
                    hideLoading();
                    showAlert('Fichier importé avec succès !', 'success');
                    
                } catch (error) {
                    hideLoading();
                    showAlert(`Erreur lors de l'import: ${error.message}`, 'error');
                    console.error('Import error:', error);
                }
            };
            
            reader.onerror = function() {
                hideLoading();
                showAlert('Erreur lors de la lecture du fichier', 'error');
            };
            
            reader.readAsText(file);
        }

        function displayImportedDataPreview(data) {
            const previewDiv = document.getElementById('importedDataPreview');
            previewDiv.style.display = 'block';
            
            document.getElementById('importedStudentName').textContent = 
                `${data.student.firstName} ${data.student.lastName}`;
            document.getElementById('importedStudentMatricule').textContent = 
                data.student.matricule;
            document.getElementById('importedGradesCount').textContent = 
                data.grades.length;
            document.getElementById('importedAverage').textContent = 
                `${data.statistics.average}/20`;
        }

        function loadImportedStudentData() {
            if (!appData.importedStudentData) {
                showAlert('Aucune donnée importée à charger', 'error');
                return;
            }
            
            const data = appData.importedStudentData;
            
            // Update the student session with imported data
            appData.currentSession = {
                userType: 'student',
                userData: data.student,
                loginTime: new Date().toISOString(),
                currentStudentId: data.student.id
            };
            
            // Temporarily store imported grades for display
            appData.importedStudentData.grades = data.grades;
            appData.importedStudentData.subjects = data.subjects || [];
            appData.importedStudentData.statistics = data.statistics;
            
            // Display the student data
            document.getElementById('studentDashboard').style.display = 'block';
            document.getElementById('noStudentData').style.display = 'none';
            displayStudentDataFromImport();
            
            showAlert('Données importées chargées avec succès !', 'success');
        }

        function displayStudentDataFromImport() {
            const data = appData.importedStudentData;
            if (!data) return;
            
            const student = data.student;
            
            // Mettre à jour les informations de l'étudiant
            document.getElementById('studentFullName').textContent = 
                `${student.firstName} ${student.lastName}`;
            document.getElementById('studentInfo').textContent = 
                `${student.class} - ${student.specialty || 'Général'} | Matricule: ${student.matricule}`;
            
            // Mettre à jour les statistiques
            document.getElementById('studentAverage').textContent = data.statistics.average;
            document.getElementById('passedSubjects').textContent = 
                `${data.statistics.passedSubjects}/${data.statistics.totalSubjects}`;
            document.getElementById('gradesCount').textContent = data.statistics.totalGrades;
            
            // Afficher les notes
            displayStudentGradesFromImport(data.grades, data.subjects);
        }

        function displayStudentGradesFromImport(grades, subjects) {
            const container = document.getElementById('studentGradesList');
            container.innerHTML = '';
            
            if (grades.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: var(--gray-color);">
                        <i class="fas fa-chart-bar" style="font-size: 2rem; margin-bottom: 10px; display: block;"></i>
                        Aucune note disponible pour le moment
                    </div>
                `;
                return;
            }
            
            // Grouper les notes par matière
            const gradesBySubject = {};
            grades.forEach(grade => {
                if (!gradesBySubject[grade.subjectId]) {
                    gradesBySubject[grade.subjectId] = [];
                }
                gradesBySubject[grade.subjectId].push(grade);
            });
            
            // Afficher chaque matière avec ses notes
            Object.entries(gradesBySubject).forEach(([subjectId, subjectGrades]) => {
                const subject = subjects.find(s => s.id === subjectId);
                if (!subject) return;
                
                // Calculer la moyenne de la matière
                const subjectTotal = subjectGrades.reduce((sum, grade) => sum + grade.value, 0);
                const subjectAverage = subjectTotal / subjectGrades.length;
                
                // Déterminer la classe CSS en fonction de la moyenne
                let gradeClass = 'grade-average';
                if (subjectAverage >= 16) gradeClass = 'grade-excellent';
                else if (subjectAverage >= 14) gradeClass = 'grade-good';
                else if (subjectAverage < 10) gradeClass = 'grade-poor';
                
                // Créer l'élément HTML
                const itemDiv = document.createElement('div');
                itemDiv.className = 'grade-item';
                
                itemDiv.innerHTML = `
                    <div class="grade-info">
                        <h4>${subject.name}</h4>
                        <p style="color: var(--gray-color); font-size: 0.9rem;">
                            ${subject.teacher} | Coefficient: ${subject.coefficient || 1} | Crédits: ${subject.credits || '-'}
                        </p>
                        <div style="font-size: 0.85rem; color: #666;">
                            ${subjectGrades.length} évaluation(s) - ${subjectAverage >= 10 ? 'Validée' : 'Non validée'}
                        </div>
                    </div>
                    <div style="text-align: right;">
                        <div style="font-size: 0.9rem; color: var(--gray-color);">Moyenne</div>
                        <div class="grade-value ${gradeClass}">${subjectAverage.toFixed(2)}/20</div>
                    </div>
                `;
                
                container.appendChild(itemDiv);
            });
        }

        function clearImportedData() {
            appData.importedStudentData = null;
            localStorage.removeItem(appData.localStorageKeys.importedStudentData);
            document.getElementById('importedDataPreview').style.display = 'none';
            document.getElementById('jsonFileInput').value = '';
            showAlert('Données importées effacées', 'success');
        }

        // ====================
        // STUDENT DISPLAY - ESPACE ÉTUDIANT
        // ====================
        function displayStudentData() {
            // Check if we have imported data or regular session data
            if (appData.importedStudentData && !appData.currentSession.currentStudentId) {
                displayStudentDataFromImport();
                return;
            }
            
            const studentId = appData.currentSession.currentStudentId;
            const student = appData.students.find(s => s.id === studentId);
            
            if (!student) {
                document.getElementById('studentDashboard').style.display = 'none';
                document.getElementById('noStudentData').style.display = 'block';
                return;
            }
            
            // Mettre à jour les informations de l'étudiant
            document.getElementById('studentFullName').textContent = 
                `${student.firstName} ${student.lastName}`;
            document.getElementById('studentInfo').textContent = 
                `${student.class} - ${student.specialty || 'Général'} | Matricule: ${student.matricule}`;
            
            // Récupérer les notes de l'étudiant
            const studentGrades = appData.grades.filter(g => g.studentId === studentId);
            
            // Calculer les statistiques
            const statistics = calculateStudentStatistics(studentId);
            
            // Mettre à jour les statistiques
            document.getElementById('studentAverage').textContent = statistics.average;
            document.getElementById('passedSubjects').textContent = 
                `${statistics.passedSubjects}/${statistics.totalSubjects}`;
            document.getElementById('gradesCount').textContent = statistics.totalGrades;
            
            // Afficher les notes
            displayStudentGrades(studentGrades);
        }

        function displayStudentGrades(studentGrades) {
            const container = document.getElementById('studentGradesList');
            container.innerHTML = '';
            
            if (studentGrades.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: var(--gray-color);">
                        <i class="fas fa-chart-bar" style="font-size: 2rem; margin-bottom: 10px; display: block;"></i>
                        Aucune note disponible pour le moment
                    </div>
                `;
                return;
            }
            
            // Grouper les notes par matière
            const gradesBySubject = {};
            studentGrades.forEach(grade => {
                if (!gradesBySubject[grade.subjectId]) {
                    gradesBySubject[grade.subjectId] = [];
                }
                gradesBySubject[grade.subjectId].push(grade);
            });
            
            // Afficher chaque matière avec ses notes
            Object.entries(gradesBySubject).forEach(([subjectId, grades]) => {
                const subject = appData.subjects.find(s => s.id === subjectId);
                if (!subject) return;
                
                // Calculer la moyenne de la matière
                const subjectTotal = grades.reduce((sum, grade) => sum + grade.value, 0);
                const subjectAverage = subjectTotal / grades.length;
                
                // Déterminer la classe CSS en fonction de la moyenne
                let gradeClass = 'grade-average';
                if (subjectAverage >= 16) gradeClass = 'grade-excellent';
                else if (subjectAverage >= 14) gradeClass = 'grade-good';
                else if (subjectAverage < 10) gradeClass = 'grade-poor';
                
                // Créer l'élément HTML
                const itemDiv = document.createElement('div');
                itemDiv.className = 'grade-item';
                
                itemDiv.innerHTML = `
                    <div class="grade-info">
                        <h4>${subject.name}</h4>
                        <p style="color: var(--gray-color); font-size: 0.9rem;">
                            ${subject.teacher} | Coefficient: ${subject.coefficient || 1} | Crédits: ${subject.credits || '-'}
                        </p>
                        <div style="font-size: 0.85rem; color: #666;">
                            ${grades.length} évaluation(s) - ${subjectAverage >= 10 ? 'Validée' : 'Non validée'}
                        </div>
                    </div>
                    <div style="text-align: right;">
                        <div style="font-size: 0.9rem; color: var(--gray-color);">Moyenne</div>
                        <div class="grade-value ${gradeClass}">${subjectAverage.toFixed(2)}/20</div>
                    </div>
                `;
                
                container.appendChild(itemDiv);
            });
        }

        // ====================
        // STUDENT FUNCTIONS - ESPACE ÉTUDIANT
        // ====================
        function exportStudentData() {
            let student, studentGrades, statistics;
            
            // Check if we're using imported data or regular data
            if (appData.importedStudentData && !appData.currentSession.currentStudentId) {
                student = appData.importedStudentData.student;
                studentGrades = appData.importedStudentData.grades;
                statistics = appData.importedStudentData.statistics;
            } else {
                const studentId = appData.currentSession.currentStudentId;
                student = appData.students.find(s => s.id === studentId);
                
                if (!student) {
                    showAlert('Aucune donnée disponible', 'error');
                    return;
                }
                
                studentGrades = appData.grades.filter(g => g.studentId === studentId);
                statistics = calculateStudentStatistics(studentId);
            }
            
            // Générer les données de l'étudiant
            const studentData = generateStudentExportData(student, studentGrades, statistics);
            
            // Exporter en JSON
            exportToJSON(studentData, `mes_donnees_${student.matricule}.json`);
            showAlert('Vos données ont été exportées', 'success');
        }

        function downloadBulletin() {
            let student, studentGrades, statistics;
            
            // Check if we're using imported data or regular data
            if (appData.importedStudentData && !appData.currentSession.currentStudentId) {
                student = appData.importedStudentData.student;
                studentGrades = appData.importedStudentData.grades;
                statistics = appData.importedStudentData.statistics;
            } else {
                const studentId = appData.currentSession.currentStudentId;
                student = appData.students.find(s => s.id === studentId);
                
                if (!student) {
                    showAlert('Aucune donnée disponible', 'error');
                    return;
                }
                
                studentGrades = appData.grades.filter(g => g.studentId === studentId);
                statistics = calculateStudentStatistics(studentId);
            }
            
            // Créer un bulletin HTML
            const bulletinHTML = generateBulletinHTML(student, studentGrades, statistics);
            
            // Exporter en HTML
            const blob = new Blob([bulletinHTML], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `bulletin_${student.matricule}.html`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showAlert('Bulletin téléchargé avec succès !', 'success');
        }

        function downloadReleve() {
            let student, studentGrades, subjects, statistics;
            
            // Check if we're using imported data or regular data
            if (appData.importedStudentData && !appData.currentSession.currentStudentId) {
                student = appData.importedStudentData.student;
                studentGrades = appData.importedStudentData.grades;
                subjects = appData.importedStudentData.subjects;
                statistics = appData.importedStudentData.statistics;
            } else {
                const studentId = appData.currentSession.currentStudentId;
                student = appData.students.find(s => s.id === studentId);
                
                if (!student) {
                    showAlert('Aucune donnée disponible', 'error');
                    return;
                }
                
                studentGrades = appData.grades.filter(g => g.studentId === studentId);
                subjects = appData.subjects.filter(s => 
                    studentGrades.some(g => g.subjectId === s.id)
                );
                statistics = calculateStudentStatistics(studentId);
            }
            
            const releveData = {
                student: student,
                grades: studentGrades,
                subjects: subjects,
                statistics: statistics,
                date: new Date().toISOString()
            };
            
            exportToJSON(releveData, `releve_notes_${student.matricule}.json`);
            showAlert('Relevé de notes téléchargé', 'success');
        }

        function viewAllGrades() {
            let student, studentGrades;
            
            // Check if we're using imported data or regular data
            if (appData.importedStudentData && !appData.currentSession.currentStudentId) {
                student = appData.importedStudentData.student;
                studentGrades = appData.importedStudentData.grades;
            } else {
                const studentId = appData.currentSession.currentStudentId;
                student = appData.students.find(s => s.id === studentId);
                
                if (!student) {
                    showAlert('Aucune donnée disponible', 'error');
                    return;
                }
                
                studentGrades = appData.grades.filter(g => g.studentId === studentId);
            }
            
            if (studentGrades.length === 0) {
                showAlert('Aucune note disponible', 'info');
                return;
            }
            
            // Get subjects from appropriate source
            const subjects = appData.importedStudentData ? 
                appData.importedStudentData.subjects : appData.subjects;
            
            // Créer un tableau avec toutes les notes détaillées
            let html = '<h3>Toutes mes notes</h3><table style="width:100%;border-collapse:collapse;margin-top:20px;">';
            html += '<tr><th style="border:1px solid #ddd;padding:10px;background:#f1f1f1;">Matière</th><th style="border:1px solid #ddd;padding:10px;background:#f1f1f1;">Type</th><th style="border:1px solid #ddd;padding:10px;background:#f1f1f1;">Note</th><th style="border:1px solid #ddd;padding:10px;background:#f1f1f1;">Date</th><th style="border:1px solid #ddd;padding:10px;background:#f1f1f1;">Commentaire</th></tr>';
            
            studentGrades.forEach(grade => {
                const subject = subjects.find(s => s.id === grade.subjectId);
                if (!subject) return;
                
                html += `<tr>
                    <td style="border:1px solid #ddd;padding:10px;">${subject.name}</td>
                    <td style="border:1px solid #ddd;padding:10px;">${grade.type || 'Note'}</td>
                    <td style="border:1px solid #ddd;padding:10px;">${grade.value.toFixed(2)}/${grade.maxScore || 20}</td>
                    <td style="border:1px solid #ddd;padding:10px;">${new Date(grade.date).toLocaleDateString('fr-FR')}</td>
                    <td style="border:1px solid #ddd;padding:10px;">${grade.comment || '-'}</td>
                </tr>`;
            });
            
            html += '</table>';
            
            // Afficher dans une alerte
            showAlert(html, 'info');
        }

        // ====================
        // EXPORT DATA - ADMINISTRATION
        // ====================
        function exportStudentFile(matricule) {
            const student = appData.students.find(s => s.matricule === matricule);
            if (!student) {
                showAlert('Étudiant non trouvé', 'error');
                return;
            }
            
            // Générer les données de l'étudiant
            const studentData = generateStudentExportData(student);
            
            // Exporter en JSON
            exportToJSON(studentData, `etudiant_${student.matricule}.json`);
            showAlert(`Fichier exporté pour ${student.firstName} ${student.lastName}`, 'success');
        }

        function exportStudentCredentials() {
            const studentId = document.getElementById('studentSelect').value;
            const student = appData.students.find(s => s.id === studentId);
            
            if (student) {
                exportStudentFile(student.matricule);
            }
        }

        function exportAllData() {
            if (appData.students.length === 0) {
                showAlert('Aucun étudiant à exporter', 'error');
                return;
            }
            
            const exportData = {
                students: appData.students.map(student => ({
                    ...student,
                    password: undefined // Masquer les mots de passe dans l'export général
                })),
                subjects: appData.subjects,
                grades: appData.grades,
                exportDate: new Date().toISOString(),
                institution: "EduManage Pro"
            };
            
            exportToJSON(exportData, `toutes_donnees_${new Date().toISOString().split('T')[0]}.json`);
            showAlert('Toutes les données ont été exportées', 'success');
        }

        function exportIndividualFiles() {
            const reportClass = document.getElementById('reportClass').value;
            
            if (!reportClass) {
                showAlert('Veuillez sélectionner une classe', 'error');
                return;
            }
            
            const studentsInClass = appData.students.filter(s => s.class === reportClass);
            
            if (studentsInClass.length === 0) {
                showAlert('Aucun étudiant dans cette classe', 'error');
                return;
            }
            
            showLoading();
            
            // Exporter un fichier pour chaque étudiant
            studentsInClass.forEach((student, index) => {
                const studentData = generateStudentExportData(student);
                exportToJSON(studentData, `etudiant_${student.matricule}.json`);
                
                if (index === studentsInClass.length - 1) {
                    hideLoading();
                    showAlert(`${studentsInClass.length} fichier(s) exporté(s) pour la classe ${reportClass}`, 'success');
                }
            });
        }

        function generateStudentExportData(student, specificGrades = null, specificStats = null) {
            const studentGrades = specificGrades || appData.grades.filter(g => g.studentId === student.id);
            const studentSubjects = appData.subjects.filter(subject => 
                studentGrades.some(grade => grade.subjectId === subject.id)
            );
            
            const statistics = specificStats || calculateStudentStatistics(student.id);
            
            return {
                student: {
                    id: student.id,
                    lastName: student.lastName,
                    firstName: student.firstName,
                    matricule: student.matricule,
                    class: student.class,
                    specialty: student.specialty,
                    email: student.email,
                    username: student.username,
                    createdAt: student.createdAt
                },
                login: {
                    matricule: student.matricule,
                    username: student.username,
                    password: student.password
                },
                grades: studentGrades,
                subjects: studentSubjects,
                statistics: statistics,
                bulletin: generateBulletinData(student.id, studentGrades, statistics),
                exportDate: new Date().toISOString(),
                institution: "EduManage Pro",
                instructions: "Ces données peuvent être utilisées pour une réimportation dans l'espace étudiant"
            };
        }

        function exportToJSON(data, filename) {
            const jsonData = JSON.stringify(data, null, 2);
            const blob = new Blob([jsonData], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // ====================
        // REPORT GENERATION
        // ====================
        function generateReport() {
            const reportClass = document.getElementById('reportClass').value;
            const reportSemester = document.getElementById('reportSemester').value;
            
            if (!reportClass) {
                showAlert('Veuillez sélectionner une classe', 'error');
                return;
            }
            
            const studentsInClass = appData.students.filter(s => s.class === reportClass);
            
            if (studentsInClass.length === 0) {
                showAlert('Aucun étudiant dans cette classe', 'error');
                return;
            }
            
            showLoading();
            
            // Générer un fichier pour chaque étudiant
            studentsInClass.forEach(student => {
                const studentData = generateStudentExportData(student);
                exportToJSON(studentData, `bulletin_${student.matricule}_${reportSemester}.json`);
            });
            
            setTimeout(() => {
                hideLoading();
                showAlert(`${studentsInClass.length} bulletin(s) généré(s) pour la classe ${reportClass}`, 'success');
            }, 1500);
        }

        function previewReport() {
            const reportClass = document.getElementById('reportClass').value;
            
            if (!reportClass) {
                showAlert('Veuillez sélectionner une classe', 'error');
                return;
            }
            
            const studentsInClass = appData.students.filter(s => s.class === reportClass);
            
            if (studentsInClass.length === 0) {
                showAlert('Aucun étudiant dans cette classe', 'error');
                return;
            }
            
            // Afficher un aperçu du premier étudiant
            const student = studentsInClass[0];
            const statistics = calculateStudentStatistics(student.id);
            
            showAlert(`Aperçu pour ${student.firstName} ${student.lastName} - Moyenne: ${statistics.average}/20`, 'info');
        }

        // ====================
        // UTILITY FUNCTIONS
        // ====================
        function calculateStudentStatistics(studentId) {
            const studentGrades = appData.grades.filter(g => g.studentId === studentId);
            
            if (studentGrades.length === 0) {
                return {
                    average: '0.0',
                    totalGrades: 0,
                    passedSubjects: 0,
                    totalSubjects: 0,
                    successRate: '0%'
                };
            }
            
            const gradesBySubject = {};
            studentGrades.forEach(grade => {
                if (!gradesBySubject[grade.subjectId]) {
                    gradesBySubject[grade.subjectId] = [];
                }
                gradesBySubject[grade.subjectId].push(grade);
            });
            
            let totalWeighted = 0;
            let totalCoefficient = 0;
            let passedSubjects = 0;
            const totalSubjects = Object.keys(gradesBySubject).length;
            
            Object.entries(gradesBySubject).forEach(([subjectId, grades]) => {
                const subject = appData.subjects.find(s => s.id === subjectId);
                if (!subject) return;
                
                const subjectTotal = grades.reduce((sum, grade) => sum + grade.value, 0);
                const subjectAverage = subjectTotal / grades.length;
                
                const coefficient = subject.coefficient || 1;
                totalWeighted += subjectAverage * coefficient;
                totalCoefficient += coefficient;
                
                if (subjectAverage >= 10) {
                    passedSubjects++;
                }
            });
            
            const overallAverage = totalCoefficient > 0 ? (totalWeighted / totalCoefficient).toFixed(2) : '0.0';
            
            return {
                average: overallAverage,
                totalGrades: studentGrades.length,
                passedSubjects: passedSubjects,
                totalSubjects: totalSubjects,
                successRate: totalSubjects > 0 ? ((passedSubjects / totalSubjects) * 100).toFixed(1) + '%' : '0%'
            };
        }

        function generateBulletinData(studentId, specificGrades = null, specificStats = null) {
            const student = appData.students.find(s => s.id === studentId);
            const statistics = specificStats || calculateStudentStatistics(studentId);
            
            return {
                student: student,
                statistics: statistics,
                generationDate: new Date().toISOString(),
                academicYear: new Date().getFullYear() + '-' + (new Date().getFullYear() + 1),
                institution: "EduManage Pro",
                remarks: getRemarks(parseFloat(statistics.average))
            };
        }

        function generateBulletinHTML(student, grades, statistics) {
            return `
                <!DOCTYPE html>
                <html>
                <head>
                    <meta charset="UTF-8">
                    <title>Bulletin - ${student.firstName} ${student.lastName}</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 40px; }
                        .header { text-align: center; margin-bottom: 30px; border-bottom: 2px solid #3498db; padding-bottom: 20px; }
                        .info { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px; }
                        .info-item { padding: 15px; background: #f8f9fa; border-radius: 8px; }
                        table { width: 100%; border-collapse: collapse; margin: 20px 0; }
                        th, td { padding: 12px; border: 1px solid #ddd; text-align: center; }
                        th { background-color: #f1f1f1; }
                        .stats { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin: 20px 0; }
                        .stat-card { text-align: center; padding: 15px; background: #f8f9fa; border-radius: 8px; }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h1>BULLETIN DE NOTES</h1>
                        <p>Année Académique ${new Date().getFullYear()}-${new Date().getFullYear() + 1}</p>
                        <p>EduManage Pro</p>
                    </div>
                    
                    <div class="info">
                        <div class="info-item">
                            <strong>Étudiant:</strong><br>
                            ${student.firstName} ${student.lastName}<br>
                            Matricule: ${student.matricule}
                        </div>
                        <div class="info-item">
                            <strong>Informations Académiques:</strong><br>
                            Classe: ${student.class}<br>
                            Spécialité: ${student.specialty || 'Non spécifiée'}
                        </div>
                    </div>
                    
                    <div class="stats">
                        <div class="stat-card">
                            <div>Moyenne Générale</div>
                            <div style="font-size: 24px; font-weight: bold; color: #3498db;">${statistics.average}/20</div>
                        </div>
                        <div class="stat-card">
                            <div>Matières Validées</div>
                            <div style="font-size: 24px; font-weight: bold; color: #2ecc71;">${statistics.passedSubjects}/${statistics.totalSubjects}</div>
                        </div>
                        <div class="stat-card">
                            <div>Taux de Réussite</div>
                            <div style="font-size: 24px; font-weight: bold; color: #f39c12;">${statistics.successRate}</div>
                        </div>
                    </div>
                    
                    <h3>Détail des Notes</h3>
                    <table>
                        <thead>
                            <tr>
                                <th>Matière</th>
                                <th>Professeur</th>
                                <th>Coefficient</th>
                                <th>Note</th>
                                <th>Appréciation</th>
                            </tr>
                        </thead>
                        <tbody>
            ` + 
            // Ajouter les lignes pour chaque matière
            (() => {
                let rows = '';
                const gradesBySubject = {};
                grades.forEach(grade => {
                    if (!gradesBySubject[grade.subjectId]) {
                        gradesBySubject[grade.subjectId] = [];
                    }
                    gradesBySubject[grade.subjectId].push(grade);
                });
                
                Object.entries(gradesBySubject).forEach(([subjectId, subjectGrades]) => {
                    const subject = appData.subjects.find(s => s.id === subjectId);
                    if (!subject) return;
                    
                    const subjectTotal = subjectGrades.reduce((sum, grade) => sum + grade.value, 0);
                    const subjectAverage = subjectTotal / subjectGrades.length;
                    
                    let appreciation = "Satisfaisant";
                    if (subjectAverage >= 16) appreciation = "Excellent";
                    else if (subjectAverage >= 14) appreciation = "Très bien";
                    else if (subjectAverage >= 12) appreciation = "Bien";
                    else if (subjectAverage >= 10) appreciation = "Satisfaisant";
                    else if (subjectAverage < 10) appreciation = "Insuffisant";
                    
                    rows += `
                        <tr>
                            <td>${subject.name}</td>
                            <td>${subject.teacher}</td>
                            <td>${subject.coefficient || 1}</td>
                            <td>${subjectAverage.toFixed(2)}/20</td>
                            <td>${appreciation}</td>
                        </tr>
                    `;
                });
                return rows;
            })() +
            `
                        </tbody>
                    </table>
                    
                    <div style="margin-top: 30px; padding: 20px; background: #f8f9fa; border-radius: 8px;">
                        <h4>Remarques:</h4>
                        <p>${getRemarks(parseFloat(statistics.average))}</p>
                    </div>
                    
                    <div style="text-align: center; margin-top: 40px; color: #666; font-size: 0.9rem;">
                        <p>Date d'émission: ${new Date().toLocaleDateString('fr-FR')}</p>
                        <p>Signature du Directeur des Études</p>
                    </div>
                </body>
                </html>
            `;
        }

        function getRemarks(average) {
            if (average >= 16) return "Excellent travail ! Continue comme ça.";
            if (average >= 14) return "Très bon travail. Continue tes efforts.";
            if (average >= 12) return "Bon travail. Peut encore progresser.";
            if (average >= 10) return "Satisfaisant. Des efforts sont nécessaires.";
            if (average >= 8) return "Insuffisant. Doit travailler davantage.";
            return "Très insuffisant. Redoublement d'efforts nécessaire.";
        }

        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                showAlert('Copié dans le presse-papier !', 'success');
            }).catch(err => {
                console.error('Erreur lors de la copie:', err);
                showAlert('Erreur lors de la copie', 'error');
            });
        }

        function showModal(modalId) {
            document.getElementById(modalId).classList.add('active');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        function showLoading() {
            document.getElementById('loadingOverlay').classList.add('active');
        }

        function hideLoading() {
            document.getElementById('loadingOverlay').classList.remove('active');
        }

        function showAlert(message, type = 'success') {
            const alertDiv = document.getElementById('appAlert');
            alertDiv.textContent = message;
            alertDiv.className = `alert alert-${type}`;
            alertDiv.style.display = 'block';
            
            setTimeout(() => {
                alertDiv.style.display = 'none';
            }, 5000);
        }

        function showLoginAlert(message, type = 'success') {
            const alertDiv = document.getElementById('loginAlert');
            alertDiv.textContent = message;
            alertDiv.className = `alert alert-${type}`;
            alertDiv.style.display = 'block';
            
            setTimeout(() => {
                alertDiv.style.display = 'none';
            }, 5000);
        }
    </script>
</body>
</html>
